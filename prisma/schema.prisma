generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── TENANCY ───────────────────────────────────────────────

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  plan      Plan     @default(STARTER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users          User[]
  stores         Store[]
  products       Product[]
  customers      Customer[]
  suppliers      Supplier[]
  orders         Order[]
  purchases      Purchase[]
  khataEntries   KhataEntry[]
  categories     Category[]
  brands         Brand[]
  manufacturers  Manufacturer[]
  incomeHeads    IncomeHead[]
  serviceGroups  ServiceGroup[]
  taxes          Tax[]
  charges        Charge[]
  combos         Combo[]
  memberships    Membership[]
  vouchers       Voucher[]
  promotions     Promotion[]
  services       Service[]
  productGroups  ProductGroup[]
  units          Unit[]
}

enum Plan {
  STARTER
  PRO
  ENTERPRISE
}

// ─── USERS ─────────────────────────────────────────────────

model User {
  id             String       @id @default(cuid())
  name           String
  email          String       @unique
  passwordHash   String
  role           UserRole     @default(STAFF)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  orders         Order[]
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  STAFF
}

// ─── STORES ────────────────────────────────────────────────

model Store {
  id             String       @id @default(cuid())
  name           String
  address        String?
  phone          String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  orders         Order[]
  inventory      Inventory[]
  productStoreMaps ProductStoreMap[]
}

// ─── CATALOG: CLASSIFICATION ───────────────────────────────

model Category {
  id             String       @id @default(cuid())
  name           String
  description    String?
  image          String?
  parentId       String?
  parent         Category?    @relation("CategoryChildren", fields: [parentId], references: [id])
  children       Category[]   @relation("CategoryChildren")
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  products       Product[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Brand {
  id             String       @id @default(cuid())
  name           String
  description    String?
  image          String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  products       Product[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Manufacturer {
  id             String       @id @default(cuid())
  name           String
  description    String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  products       Product[]
  createdAt      DateTime     @default(now())
}

model IncomeHead {
  id             String       @id @default(cuid())
  name           String
  description    String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  products       Product[]
  createdAt      DateTime     @default(now())
}

model ServiceGroup {
  id             String       @id @default(cuid())
  name           String
  description    String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  services       Service[]
  createdAt      DateTime     @default(now())
}

model Unit {
  id             String       @id @default(cuid())
  name           String
  shortName      String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  products       Product[]
  createdAt      DateTime     @default(now())
}

// ─── CATALOG: TAXES & CHARGES ──────────────────────────────

model Tax {
  id             String       @id @default(cuid())
  name           String
  rate           Float
  type           TaxType      @default(PERCENTAGE)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  products       Product[]
  createdAt      DateTime     @default(now())
}

enum TaxType {
  PERCENTAGE
  FIXED
}

model Charge {
  id             String       @id @default(cuid())
  name           String
  amount         Float
  type           ChargeType   @default(PERCENTAGE)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  products       Product[]
  createdAt      DateTime     @default(now())
}

enum ChargeType {
  PERCENTAGE
  FIXED
}

// ─── CATALOG: PRODUCTS ─────────────────────────────────────

model Product {
  id               String        @id @default(cuid())
  name             String
  description      String?
  sku              String?
  barcode          String?
  hsnCode          String?
  price            Float         @default(0)
  mrp              Float?
  costPrice        Float         @default(0)
  size             String?
  color            String?
  image            String?
  isActive         Boolean       @default(true)
  manageInventory  Boolean       @default(false)
  priceIncludesTax Boolean       @default(false)
  autoBarcode      Boolean       @default(false)
  categoryId       String?
  category         Category?     @relation(fields: [categoryId], references: [id])
  brandId          String?
  brand            Brand?        @relation(fields: [brandId], references: [id])
  manufacturerId   String?
  manufacturer     Manufacturer? @relation(fields: [manufacturerId], references: [id])
  incomeHeadId     String?
  incomeHead       IncomeHead?   @relation(fields: [incomeHeadId], references: [id])
  unitId           String?
  unit             Unit?         @relation(fields: [unitId], references: [id])
  taxId            String?
  tax              Tax?          @relation(fields: [taxId], references: [id])
  chargeId         String?
  charge           Charge?       @relation(fields: [chargeId], references: [id])
  organizationId   String
  organization     Organization  @relation(fields: [organizationId], references: [id])
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  inventory        Inventory[]
  orderItems       OrderItem[]
  purchaseItems    PurchaseItem[]
  productStoreMaps ProductStoreMap[]
  comboItems       ComboItem[]
}

model ProductGroup {
  id             String       @id @default(cuid())
  name           String
  description    String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
}

model Service {
  id             String        @id @default(cuid())
  name           String
  description    String?
  price          Float         @default(0)
  duration       Int?          // minutes
  serviceGroupId String?
  serviceGroup   ServiceGroup? @relation(fields: [serviceGroupId], references: [id])
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id])
  createdAt      DateTime      @default(now())
}

// ─── CATALOG: PRICING ──────────────────────────────────────

model ProductStoreMap {
  id             String   @id @default(cuid())
  productId      String
  product        Product  @relation(fields: [productId], references: [id])
  storeId        String
  store          Store    @relation(fields: [storeId], references: [id])
  price          Float?
  isAvailable    Boolean  @default(true)
  createdAt      DateTime @default(now())

  @@unique([productId, storeId])
}

// ─── CATALOG: PROMOTIONAL ──────────────────────────────────

model Combo {
  id             String      @id @default(cuid())
  name           String
  description    String?
  price          Float
  isActive       Boolean     @default(true)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  items          ComboItem[]
  createdAt      DateTime    @default(now())
}

model ComboItem {
  id        String  @id @default(cuid())
  comboId   String
  combo     Combo   @relation(fields: [comboId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Float   @default(1)
}

model Membership {
  id             String       @id @default(cuid())
  name           String
  description    String?
  price          Float
  durationDays   Int
  discountPct    Float        @default(0)
  isActive       Boolean      @default(true)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
}

model Voucher {
  id             String       @id @default(cuid())
  code           String       @unique
  name           String
  type           VoucherType  @default(PERCENTAGE)
  value          Float
  minOrderValue  Float        @default(0)
  maxUses        Int?
  usedCount      Int          @default(0)
  validFrom      DateTime?
  validTo        DateTime?
  isActive       Boolean      @default(true)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
}

enum VoucherType {
  PERCENTAGE
  FIXED
}

model Promotion {
  id             String          @id @default(cuid())
  name           String
  type           PromotionType   @default(PERCENTAGE)
  value          Float
  validFrom      DateTime?
  validTo        DateTime?
  isActive       Boolean         @default(true)
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id])
  createdAt      DateTime        @default(now())
}

enum PromotionType {
  PERCENTAGE
  FIXED
  BUY_X_GET_Y
}

// ─── INVENTORY ─────────────────────────────────────────────

model Inventory {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  quantity  Float    @default(0)
  updatedAt DateTime @updatedAt

  @@unique([productId, storeId])
}

// ─── ORDERS / POS ──────────────────────────────────────────

model Order {
  id             String      @id @default(cuid())
  orderNumber    String      @unique
  status         OrderStatus @default(PENDING)
  subtotal       Float
  taxAmount      Float       @default(0)
  discount       Float       @default(0)
  total          Float
  paymentMethod  String      @default("CASH")
  customerId     String?
  customer       Customer?   @relation(fields: [customerId], references: [id])
  storeId        String
  store          Store       @relation(fields: [storeId], references: [id])
  userId         String
  user           User        @relation(fields: [userId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  items          OrderItem[]
  createdAt      DateTime    @default(now())
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Float
  price     Float
  discount  Float   @default(0)
  total     Float
}

// ─── CUSTOMERS ─────────────────────────────────────────────

model Customer {
  id             String       @id @default(cuid())
  name           String
  phone          String?
  email          String?
  address        String?
  creditLimit    Float        @default(0)
  balance        Float        @default(0)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  orders         Order[]
  khataEntries   KhataEntry[]
  createdAt      DateTime     @default(now())
}

// ─── SUPPLIERS & PURCHASE ──────────────────────────────────

model Supplier {
  id             String     @id @default(cuid())
  name           String
  phone          String?
  email          String?
  balance        Float      @default(0)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  purchases      Purchase[]
  createdAt      DateTime   @default(now())
}

model Purchase {
  id             String         @id @default(cuid())
  purchaseNumber String         @unique
  status         PurchaseStatus @default(PENDING)
  total          Float
  supplierId     String
  supplier       Supplier       @relation(fields: [supplierId], references: [id])
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id])
  items          PurchaseItem[]
  createdAt      DateTime       @default(now())
}

enum PurchaseStatus {
  PENDING
  RECEIVED
  CANCELLED
}

model PurchaseItem {
  id         String   @id @default(cuid())
  purchaseId String
  purchase   Purchase @relation(fields: [purchaseId], references: [id])
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  quantity   Float
  costPrice  Float
  total      Float
}

// ─── KHATA ─────────────────────────────────────────────────

model KhataEntry {
  id             String     @id @default(cuid())
  type           KhataType
  amount         Float
  note           String?
  customerId     String
  customer       Customer   @relation(fields: [customerId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime   @default(now())
}

enum KhataType {
  CREDIT
  DEBIT
  PAYMENT
}
